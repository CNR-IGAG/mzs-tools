[tox]
envlist = qgis-latest,qgis-stable,qgis-ltr,qgis-qt6,qgis-qt6-ubuntu,qgis-qt6-ubuntu-gui
skipsdist = True

[testenv]
# Base environment - tests run INSIDE Docker containers with QGIS installed
skip_install = True
passenv =
    DOCKER_*
    CI
allowlist_externals =
    docker
    bash
deps =

[testenv:qgis-latest]
description = Run tests with QGIS latest stable (Qt5)
commands =
    bash -c ' \
        docker pull qgis/qgis:latest && \
        docker run --rm -t \
            --name mzs-tools-test-qgis-latest \
            -v {toxinidir}:/tests_directory \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e PYTHONPATH=/usr/share/qgis/python:/tests_directory \
            qgis/qgis:latest \
            bash -c "apt remove -y python3-pluggy && apt install -y --no-install-recommends default-jre && cd /tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/ -v -rs --qgis_disable_gui" \
    '

[testenv:qgis-stable]
description = Run tests with QGIS stable 3.44 (Qt5)
commands =
    bash -c ' \
        docker pull qgis/qgis:stable-noble && \
        docker run --rm -t \
            --name mzs-tools-test-qgis-stable \
            -v {toxinidir}:/tests_directory \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e PYTHONPATH=/usr/share/qgis/python:/tests_directory \
            qgis/qgis:stable-noble \
            bash -c "apt remove -y python3-pluggy && apt install -y --no-install-recommends default-jre && cd /tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/ -v -rs --qgis_disable_gui" \
    '

[testenv:qgis-ltr]
description = Run tests with QGIS LTR 3.40 (Qt5)
commands =
    bash -c ' \
        docker pull qgis/qgis:ltr-noble && \
        docker run --rm -t \
            --name mzs-tools-test-qgis-ltr \
            -v {toxinidir}:/tests_directory \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e PYTHONPATH=/usr/share/qgis/python:/tests_directory \
            qgis/qgis:ltr-noble \
            bash -c "apt remove -y python3-pluggy && apt install -y --no-install-recommends default-jre && cd /tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/ -v -rs --qgis_disable_gui" \
    '

[testenv:qgis-old]
description = Run tests with QGIS 3.34.13 (Qt5)
commands =
    bash -c ' \
        docker pull qgis/qgis:3.34.13-noble && \
        docker run --rm -t \
            --name mzs-tools-test-qgis-old \
            -v {toxinidir}:/tests_directory \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e PYTHONPATH=/usr/share/qgis/python:/tests_directory \
            qgis/qgis:3.34.13-noble \
            bash -c "apt remove -y python3-pluggy && apt install -y --no-install-recommends default-jre && cd /tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/ -v -rs --qgis_disable_gui" \
    '

# Qt6 environment - Uses custom built QGIS 3.44 with Qt6 (underlying image is Fedora 39)
# Must run "just build-image-qgis-qt6-linux-deps-only" and prepare the QGIS build dir before using this environment
[testenv:qgis-qt6]
description = Run tests with QGIS 3.44 with Qt6 support
commands =
    bash -c ' \
        docker run --rm -t \
            --name mzs-tools-test-qgis-qt6 \
            -v {toxinidir}:/tests_directory \
            -v $HOME/QGIS:/home/quser/QGIS \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e LC_ALL=C.utf8 \
            -e LANG=C.utf8 \
            -e PYTHONPATH=/home/quser/QGIS/build/output/python:/tests_directory \
            -e QGIS_PREFIX_PATH=/home/quser/QGIS/build/output \
            qgis-qt6-linux-deps-only:3_44 \
            bash -c "sudo dnf install -y java-21-openjdk && cd /tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/integration/test_qgis_env.py -v -rs --qgis_disable_gui" \
    '

# Qt6 environment - Uses ubuntu "questing" with official QGIS nightly (3.99) repository with Qt6
# Must run "just build-image-qgis-qt6-ubuntu-master" before using this environment
[testenv:qgis-qt6-ubuntu]
description = Run tests with QGIS nightly with Qt6 support on ubuntu questing
commands =
    bash -c ' \
        docker run --rm -t \
            --name mzs-tools-test-qgis-qt6-ubuntu \
            -v {toxinidir}:/home/quser/tests_directory \
            -e DISPLAY=:99 \
            -e QT_QPA_PLATFORM=offscreen \
            -e LC_ALL=C.utf8 \
            -e LANG=C.utf8 \
            -e COVERAGE_FILE=/tmp/.coverage \
            -e PYTHONPATH=/usr/share/qgis-qt6/python:/home/quser/tests_directory \
            qgis-qt6-ubuntu:master \
            bash -c "cd /home/quser/tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy jaydebeapi && python3 -m pytest tests/ -v -rs --qgis_disable_gui -m \"not visual\" " \
    '

# Qt6 environment - Uses ubuntu "questing" with official QGIS nightly (3.99) repository with Qt6
# Must run "just build-image-qgis-qt6-ubuntu-master" before using this environment
# This environment supports GUI display for visual testing
# Set GUI_TIMEOUT environment variable to control how long GUIs stay open (seconds), e.g., GUI_TIMEOUT=5
# TODO: Tests using "qgis_show_map" fixture are failing atm with qgis master, so "visual" marked tests are skipped for now
[testenv:qgis-qt6-ubuntu-gui]
description = Run tests with QGIS nightly with Qt6 support on ubuntu questing (GUI enabled)
passenv =
    {[testenv]passenv}
    DISPLAY
    GUI_TIMEOUT
    XAUTHORITY
commands =
    bash -c ' \
        if [ -z "$DISPLAY" ]; then \
            echo "Error: DISPLAY environment variable is not set. GUI display requires an X server."; \
            echo "If you want to run tests without GUI, use a different test environment."; \
            exit 1; \
        fi; \
        (command -v xhost > /dev/null 2>&1 && xhost +local:docker) || echo "Warning: xhost not available, X11 forwarding may not work"; \
        docker run --rm -t \
            --name mzs-tools-test-qgis-qt6-ubuntu \
            --network host \
            -v {toxinidir}:/home/quser/tests_directory \
            -v /tmp/.X11-unix:/tmp/.X11-unix:rw \
            -e DISPLAY=$DISPLAY \
            -e GUI_TIMEOUT \
            -e QT_X11_NO_MITSHM=1 \
            -e LC_ALL=C.utf8 \
            -e LANG=C.utf8 \
            -e COVERAGE_FILE=/tmp/.coverage \
            -e PYTHONPATH=/usr/share/qgis-qt6/python:/home/quser/tests_directory \
            qgis-qt6-ubuntu:master \
            bash -c "if [ -z \"$GUI_TIMEOUT\" ]; then export GUI_TIMEOUT=2; fi; cd /home/quser/tests_directory && python3 -m pip install --break-system-packages pytest pytest-qt pytest-qgis pytest-sugar pytest-env factory-boy && python3 -m pytest tests/ -v -rs -m \"not visual\" " \
    '

# Run all QGIS versions
[testenv:all]
description = Run tests with all QGIS versions
skip_install = True
deps =
allowlist_externals =
    tox
commands =
    tox -e qgis-latest
    tox -e qgis-stable
    tox -e qgis-ltr
    tox -e qgis-old
    tox -e qgis-qt6-ubuntu

